;---------------------------------------------------
; Programa: MULTIPLICAÇÃO 8 BITS
; Autor: GABRIEL AUREO
; Data: 04/09/2018
;---------------------------------------------------

;VARIAVEIS DA ROTNA PRINCIPAL
ORG 0
  N: DB 0
  M: DB 0
  RES: DW 0

ORG 100

MAIN:
  LDA #N
  PUSH
  JSR SCAN
  LDA #M
  PUSH
  JSR SCAN


  LDA N
  PUSH
  LDA M
  PUSH
  LDA #RES
  PUSH
  JSR MULT
  HLT
  END MAIN

ORG 300

;VARIAVEIS SCANB

SP0: DW 0
INPUT: DW 0

ORG 500
;SUBROTINA QUE SCANEIA ENTRADA E GUARDA EM UM PONTEIRO PASSADO PELA PILHA
SCAN:
  STS SP0
  POP
  POP
  POP
  STA INPUT

INPUTLOOP:
  IN 1
  AND #1
  JZ INPUTLOOP
  IN 0
  STA @INPUT

  LDS SP0
  RET

ORG 800

  X: DW 0
  Y: DB 0
  Z: DW 0
  PTR: DW 0
  HIOF: DB 0 ;VARIÁVEL USADA PARA GUARDAR FLAG DE OVERFLOW AO DUPLICAR X
  SP1: DW 0

ORG 900
;ROTINA DE MULTIPLICAÇÃO BASEADA NO ALGORITMO DE MULTIPLICAÇÃO RUSSA
;PSEUDOCÓDIGO:
;1)RESULTADO = 0
;2)ENQUANTO Y > 0
  ;A) SE Y FOR ÍMPAR, SOMAR X AO RESULTADO
  ;B) DUPLICAR X E DIVIDIR Y POR 2
MULT:
  STS SP1
  POP
  POP
  POP
  STA PTR
  POP
  STA Y
  POP
  STA X

MULTLOOP:
;Verifica se Y foi dividido ao ponto de chegar a zero
  LDA Y
  JZ RETURN
  AND #1
  JZ SHIFT

  LDA Z
  ADD X
  STA Z
  LDA Z+1
  ADC X+1
  STA Z+1
  JC OVERFLOW
;CASO OCORRA OVERFLOW AO INCREMENTAR O RESULTADO, OBRIGATORIAMENTE O VALOR DA MULTIPLICAÇÃO FOI ALCANÇANDO, PORTANTO A ROTINA PODE TERMINAR

SHIFT:
;DOBRA O PRIMEIRO VALOR
  LDA X
  SHL
  STA X
  LDA #0
  JNC HISHIFT
  LDA #1

HISHIFT:
  STA HIOF
  LDA X+1
  SHL
  ADD HIOF
  STA X+1

  LDA Y
  SHR
  STA Y
  JMP MULTLOOP

OVERFLOW:
  LDA #1
RETURN:
  LDS Z
  STS @PTR
  LDS SP1
  RET

